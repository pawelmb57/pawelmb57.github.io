<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fort Myers Open Houses</title>
    
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <!-- FontAwesome for Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        /* Custom scrollbar for the sidebar */
        .listing-scroll::-webkit-scrollbar {
            width: 8px;
        }
        .listing-scroll::-webkit-scrollbar-track {
            background: #f1f1f1; 
        }
        .listing-scroll::-webkit-scrollbar-thumb {
            background: #cbd5e1; 
            border-radius: 4px;
        }
        .listing-scroll::-webkit-scrollbar-thumb:hover {
            background: #94a3b8; 
        }

        /* Map height calculation to fill screen minus header */
        #map {
            height: 50vh;
            width: 100%;
            z-index: 1;
        }

        @media (min-width: 768px) {
            #map {
                height: calc(100vh - 80px); /* Full height minus header */
            }
        }

        .card-active {
            border-left: 4px solid #ef4444; /* Red border for active */
            background-color: #fef2f2;
        }

        /* Custom Marker Styles */
        .custom-div-icon {
            background: transparent;
            border: none;
        }
        .marker-pin {
            display: flex;
            align-items: center;
            justify-content: center;
            filter: drop-shadow(0 2px 2px rgba(0,0,0,0.3));
            transition: all 0.3s ease;
            position: relative;
        }
        
        /* Badges for Drive Time */
        .dt-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background-color: #f59e0b; /* Amber-500 */
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: bold;
            border: 2px solid white;
            z-index: 10;
        }

        /* Modal Animation */
        .modal-enter {
            opacity: 0;
            transform: scale(0.95);
        }
        .modal-enter-active {
            opacity: 1;
            transform: scale(1);
            transition: opacity 200ms ease-out, transform 200ms ease-out;
        }
        .modal-exit {
            opacity: 1;
        }
        .modal-exit-active {
            opacity: 0;
            transition: opacity 200ms ease-in;
        }
    </style>
</head>
<body class="bg-gray-50 h-screen flex flex-col overflow-hidden relative">

    <!-- Header / Filter Bar -->
    <header class="bg-white shadow-md z-20 p-4 shrink-0 flex flex-col gap-4">
        
        <!-- Top Row: Controls -->
        <div class="flex items-center justify-between">
            <div class="flex items-center gap-2">
                <i class="fa-solid fa-map-location-dot text-blue-600 text-2xl"></i>
                <h1 class="text-xl font-bold text-gray-800 hidden sm:block">Fort Myers Hunt</h1>
            </div>

            <!-- Filters & Tools -->
            <div class="flex gap-2 sm:gap-4 overflow-x-auto items-center">
                
                <!-- Favorites Toggle -->
                <button id="favFilterBtn" onclick="toggleFavFilter()" class="border border-gray-300 text-gray-600 px-3 py-1 rounded text-sm hover:bg-gray-50 flex items-center gap-2 transition whitespace-nowrap">
                    <i class="fa-regular fa-heart text-red-500"></i> <span class="hidden sm:inline">Favorites</span>
                </button>
                
                <div class="h-6 w-px bg-gray-300 mx-1"></div>

                <!-- Date Filter -->
                <div class="flex items-center gap-2">
                    <label class="text-sm text-gray-600 hidden sm:block">Date:</label>
                    <select id="dateFilter" onchange="applyFilters()" class="border border-gray-300 rounded px-2 py-1 text-sm focus:outline-none focus:border-blue-500 bg-white">
                        <option value="all">All Dates</option>
                        <!-- Dates populated dynamically -->
                    </select>
                </div>

                <!-- Advanced Filters Button -->
                <button onclick="openFilterModal()" class="bg-blue-600 text-white px-4 py-1.5 rounded text-sm hover:bg-blue-700 transition flex items-center gap-2 whitespace-nowrap shadow-sm">
                    <i class="fa-solid fa-sliders"></i> Filters
                </button>

                <!-- Drive Time Button -->
                <button id="driveTimeBtn" onclick="toggleDriveTimeMode()" class="bg-emerald-600 text-white px-4 py-1.5 rounded text-sm hover:bg-emerald-700 transition flex items-center gap-2 whitespace-nowrap shadow-sm">
                    <i class="fa-solid fa-car"></i> Drive Time
                </button>
            </div>
        </div>

        <!-- Drive Time Panel (Hidden by default) -->
        <div id="driveTimePanel" class="hidden bg-emerald-50 border border-emerald-200 rounded-lg p-3 text-sm">
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4 items-center">
                <!-- Col 1: Start -->
                <div class="flex flex-col">
                    <span class="font-bold text-emerald-800 text-xs uppercase">Select First Point</span>
                    <span id="dtStartText" class="text-gray-600 truncate">Click a pin on the map</span>
                </div>
                <!-- Col 2: End -->
                <div class="flex flex-col">
                    <span class="font-bold text-emerald-800 text-xs uppercase">Select Second Point</span>
                    <span id="dtEndText" class="text-gray-600 truncate">Click another pin on the map</span>
                </div>
                <!-- Col 3: Status -->
                <div class="flex flex-col">
                    <span class="font-bold text-emerald-800 text-xs uppercase">Status</span>
                    <span id="dtStatusText" class="text-gray-800 font-medium">Select two points to calculate drive time</span>
                </div>
                <!-- Col 4: Controls -->
                <div class="flex gap-2 justify-end">
                    <button onclick="clearDriveTimeRoute()" class="px-3 py-1 bg-white border border-gray-300 rounded text-gray-700 hover:bg-gray-50 text-xs">Clear Route</button>
                    <button onclick="toggleDriveTimeMode()" class="px-3 py-1 bg-gray-200 border border-gray-300 rounded text-gray-700 hover:bg-gray-300 text-xs">Close / Reset</button>
                </div>
            </div>

            <!-- Results Section (Hidden until route calculated) -->
            <div id="driveTimeResults" class="hidden mt-3 pt-3 border-t border-emerald-200">
                <div class="flex flex-col sm:flex-row justify-between items-center gap-4">
                    <div class="text-emerald-900">
                        <span class="font-bold text-lg mr-4"><i class="fa-regular fa-clock"></i> <span id="resTime">-- min</span></span>
                        <span class="text-gray-600"><i class="fa-solid fa-road"></i> <span id="resDist">-- miles</span></span>
                    </div>
                    <a id="googleMapsLink" href="#" target="_blank" class="bg-white border border-emerald-500 text-emerald-700 hover:bg-emerald-50 px-4 py-1.5 rounded text-xs font-bold transition flex items-center gap-2">
                        <i class="fa-brands fa-google"></i> Show Route with Traffic
                    </a>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <div class="flex flex-col-reverse md:flex-row flex-1 overflow-hidden relative">
        
        <!-- Sidebar Listing View -->
        <div class="w-full md:w-1/3 lg:w-1/4 bg-white shadow-lg z-10 overflow-y-auto listing-scroll" id="listings-container">
            <!-- Listings will be injected here via JS -->
        </div>

        <!-- Map View -->
        <div class="w-full md:w-2/3 lg:w-3/4 relative bg-gray-200">
            <div id="map"></div>
            <!-- Map Overlay Info -->
            <div class="absolute bottom-4 left-4 bg-white/90 backdrop-blur px-3 py-2 rounded shadow text-xs z-[1000] pointer-events-none">
                <i class="fa-solid fa-arrows-up-down-left-right mr-1"></i> Move map to update list
            </div>
        </div>

    </div>

    <!-- Full Screen Details Modal -->
    <div id="detailsModal" class="fixed inset-0 z-50 hidden bg-white flex flex-col">
        <div class="bg-gray-900 text-white p-4 shrink-0 flex items-center justify-between shadow-lg">
            <div class="flex flex-col sm:flex-row sm:items-center gap-2 sm:gap-6">
                <div class="text-2xl font-bold text-green-400" id="modalPrice">$0</div>
                <div class="flex items-center gap-2 text-gray-300 text-sm sm:text-base">
                    <i class="fa-regular fa-clock"></i>
                    <span id="modalTime">Date & Time</span>
                </div>
            </div>
            <button onclick="closeModal('detailsModal')" class="text-white hover:text-red-400 transition p-2">
                <i class="fa-solid fa-xmark text-3xl"></i>
            </button>
        </div>
        <div class="flex-1 overflow-y-auto p-4 sm:p-8 bg-gray-50">
            <div class="max-w-4xl mx-auto bg-white rounded-lg shadow p-6">
                <h2 id="modalAddress" class="text-2xl font-bold text-gray-800 mb-6 border-b pb-2">Address</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-x-8 gap-y-4 text-sm text-gray-700" id="modalGrid"></div>
            </div>
        </div>
    </div>

    <!-- Full Screen Filter Modal -->
    <div id="filterModal" class="fixed inset-0 z-50 hidden bg-white flex flex-col">
        <!-- Header -->
        <div class="bg-white border-b p-4 shrink-0 flex items-center justify-between shadow-sm">
            <h2 class="text-xl font-bold text-gray-800">Filters</h2>
            <button onclick="closeModal('filterModal')" class="text-gray-500 hover:text-gray-800 p-2">
                <i class="fa-solid fa-xmark text-2xl"></i>
            </button>
        </div>

        <!-- Filter Content -->
        <div class="flex-1 overflow-y-auto p-4 bg-gray-50">
            <div class="max-w-3xl mx-auto bg-white rounded-lg shadow-sm border border-gray-200 p-6 space-y-8">
                
                <!-- Open House Time -->
                <div>
                    <h3 class="font-bold text-gray-800 mb-4 flex items-center gap-2">
                        <i class="fa-regular fa-clock text-blue-600"></i> Open House Time
                    </h3>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Starts On or Before</label>
                            <select id="filterTimeStart" class="w-full border rounded p-2 text-sm">
                                <option value="">Any Time</option>
                                <option value="900">9:00 AM</option>
                                <option value="1000">10:00 AM</option>
                                <option value="1100">11:00 AM</option>
                                <option value="1200">12:00 PM</option>
                                <option value="1300">1:00 PM</option>
                                <option value="1400">2:00 PM</option>
                                <option value="1500">3:00 PM</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Ends On or After</label>
                            <select id="filterTimeEnd" class="w-full border rounded p-2 text-sm">
                                <option value="">Any Time</option>
                                <option value="1100">11:00 AM</option>
                                <option value="1200">12:00 PM</option>
                                <option value="1300">1:00 PM</option>
                                <option value="1400">2:00 PM</option>
                                <option value="1500">3:00 PM</option>
                                <option value="1600">4:00 PM</option>
                                <option value="1700">5:00 PM</option>
                            </select>
                        </div>
                    </div>
                </div>

                <hr>

                <!-- Basic Property Info -->
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-6">
                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-1">City</label>
                        <select id="filterCity" class="w-full border rounded p-2 text-sm">
                            <option value="">All Cities</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Property Type</label>
                        <select id="filterType" class="w-full border rounded p-2 text-sm">
                            <option value="">All Types</option>
                        </select>
                    </div>
                </div>

                <!-- Price Range -->
                <div>
                    <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Price</label>
                    <div class="flex gap-2 items-center">
                        <select id="filterPriceMin" class="w-full border rounded p-2 text-sm">
                            <option value="">No Min</option>
                            <option value="0">$0</option>
                            <option value="100000">$100k</option>
                            <option value="200000">$200k</option>
                            <option value="300000">$300k</option>
                            <option value="400000">$400k</option>
                            <option value="500000">$500k</option>
                            <option value="600000">$600k</option>
                            <option value="700000">$700k</option>
                            <option value="800000">$800k</option>
                            <option value="900000">$900k</option>
                            <option value="1000000">$1M</option>
                        </select>
                        <span class="text-gray-400">-</span>
                        <select id="filterPriceMax" class="w-full border rounded p-2 text-sm">
                            <option value="">No Max</option>
                            <option value="100000">$100k</option>
                            <option value="200000">$200k</option>
                            <option value="300000">$300k</option>
                            <option value="400000">$400k</option>
                            <option value="500000">$500k</option>
                            <option value="600000">$600k</option>
                            <option value="700000">$700k</option>
                            <option value="800000">$800k</option>
                            <option value="900000">$900k</option>
                            <option value="1000000">$1M</option>
                        </select>
                    </div>
                </div>

                <!-- Features (Minimums) -->
                <div>
                    <h3 class="font-bold text-gray-800 mb-4">Features (Minimum)</h3>
                    <div class="grid grid-cols-2 sm:grid-cols-4 gap-4">
                        <div>
                            <label class="block text-xs text-gray-500 mb-1">Beds</label>
                            <input type="number" id="filterBeds" class="w-full border rounded p-2 text-sm" placeholder="0+">
                        </div>
                        <div>
                            <label class="block text-xs text-gray-500 mb-1">Baths</label>
                            <input type="number" id="filterBaths" class="w-full border rounded p-2 text-sm" placeholder="0+">
                        </div>
                        <div>
                            <label class="block text-xs text-gray-500 mb-1">SqFt</label>
                            <input type="number" id="filterSqft" class="w-full border rounded p-2 text-sm" placeholder="0+">
                        </div>
                        <div>
                            <label class="block text-xs text-gray-500 mb-1">Lot Size (sqft)</label>
                            <input type="number" id="filterLot" class="w-full border rounded p-2 text-sm" placeholder="0+">
                        </div>
                    </div>
                </div>

                <!-- Details (Minimums) -->
                <div>
                    <h3 class="font-bold text-gray-800 mb-4">Details (Minimum)</h3>
                    <div class="grid grid-cols-2 sm:grid-cols-4 gap-4">
                        <div>
                            <label class="block text-xs text-gray-500 mb-1">Year Built</label>
                            <input type="number" id="filterYear" class="w-full border rounded p-2 text-sm" placeholder="Year">
                        </div>
                        <div>
                            <label class="block text-xs text-gray-500 mb-1">Days on Market</label>
                            <input type="number" id="filterDom" class="w-full border rounded p-2 text-sm" placeholder="Days">
                        </div>
                        <div>
                            <label class="block text-xs text-gray-500 mb-1">$/SqFt</label>
                            <input type="number" id="filterPpsf" class="w-full border rounded p-2 text-sm" placeholder="$">
                        </div>
                        <div>
                            <label class="block text-xs text-gray-500 mb-1">HOA/Month</label>
                            <input type="number" id="filterHoa" class="w-full border rounded p-2 text-sm" placeholder="$">
                        </div>
                    </div>
                </div>

            </div>
        </div>

        <!-- Footer -->
        <div class="bg-white border-t p-4 shrink-0 flex justify-end gap-2">
            <button onclick="resetFilters()" class="px-4 py-2 text-gray-600 hover:text-gray-900 font-medium">Reset</button>
            <button onclick="applyFiltersAndClose()" class="bg-blue-600 text-white px-6 py-2 rounded font-medium hover:bg-blue-700">Show Results</button>
        </div>
    </div>

    <script>
        // --- DATA INPUT ---
        const rawJsonData = [
            {"Open House Date":"Saturday Dec 06","Start Time":"11:00 AM","End Time":"03:00 PM","PRICE":"$360,000","URL":"https:\/\/www.redfin.com\/FL\/Punta-Gorda\/385-Viedma-St-33983\/home\/47531261","ADDRESS":"385 Viedma St","CITY":"Punta Gorda","SALE TYPE":"MLS Listing","SOLD DATE":null,"PROPERTY TYPE":"Single Family Residential","STATE OR PROVINCE":"FL","ZIP OR POSTAL CODE":33983.0,"BEDS":3.0,"BATHS":2.0,"LOCATION":"PUNTA GORDA ISLES SEC 20","SQUARE FEET":1757.0,"LOT SIZE":12784.0,"YEAR BUILT":2004.0,"DAYS ON MARKET":91.0,"$\/SQUARE FEET":205.0,"HOA\/MONTH":16.0,"STATUS":"Active","NEXT OPEN HOUSE START TIME":"December-6-2025 11:00 AM","NEXT OPEN HOUSE END TIME":"December-6-2025 03:00 PM","SOURCE":"Stellar MLS as Distributed by MLS Grid","MLS#":"TB8423300","FAVORITE":"N","INTERESTED":"Y","LATITUDE":27.0214102,"LONGITUDE":-82.0138871,"area":"charlotte","Start Time Range":"10AM\u201312PM","End Time Range":"2PM\u20134PM","24 Start Time":1100,"24 End Time":1500},
            {"Open House Date":"Saturday Dec 06","Start Time":"12:30 PM","End Time":"02:30 PM","PRICE":"$225,000","URL":"https:\/\/www.redfin.com\/FL\/Punta-Gorda\/1255-Saxony-Cir-33983\/unit-4106\/home\/47392527","ADDRESS":"1255 Saxony Cir #4106","CITY":"Punta Gorda","SALE TYPE":"Condo\/Co-op","SOLD DATE":null,"PROPERTY TYPE":"Condo\/Co-op","STATE OR PROVINCE":"FL","ZIP OR POSTAL CODE":33983.0,"BEDS":2.0,"BATHS":2.0,"LOCATION":"LINKS EDGE PH 01 BLDG 04","SQUARE FEET":1291.0,"LOT SIZE":1211.0,"YEAR BUILT":2004.0,"DAYS ON MARKET":1.0,"$\/SQUARE FEET":174.0,"HOA\/MONTH":326.0,"STATUS":"Active","NEXT OPEN HOUSE START TIME":"December-6-2025 12:30 PM","NEXT OPEN HOUSE END TIME":"December-6-2025 02:30 PM","SOURCE":"Stellar MLS as Distributed by MLS Grid","MLS#":"C7518589","FAVORITE":"N","INTERESTED":"Y","LATITUDE":27.0103858,"LONGITUDE":-82.018829,"area":"charlotte","Start Time Range":"12PM\u20132PM","End Time Range":"2PM\u20134PM","24 Start Time":1230,"24 End Time":1430}
        ];

        // --- PROCESSING ---
        function processData(rawData) {
            return rawData.map((item, index) => {
                const numericPrice = parseInt(item.PRICE.replace(/[$,]/g, ''));
                return {
                    id: item["MLS#"],
                    title: `${item.ADDRESS}`,
                    price: numericPrice,
                    address: `${item.CITY}, ${item["STATE OR PROVINCE"]} ${item["ZIP OR POSTAL CODE"]}`,
                    beds: item.BEDS,
                    baths: item.BATHS,
                    sqft: item["SQUARE FEET"],
                    openDate: item["Open House Date"],
                    openTime: `${item["Start Time"]} - ${item["End Time"]}`,
                    lat: item.LATITUDE,
                    lng: item.LONGITUDE,
                    url: item.URL,
                    rawData: item 
                };
            });
        }

        const listings = processData(rawJsonData);

        // --- STATE ---
        let map;
        let markers = {};
        let activeId = null;
        let currentFilteredData = [...listings];
        let favorites = [];
        let isFavFilterActive = false;
        
        // Drive Time State
        let isDriveTimeMode = false;
        let dtStartId = null;
        let dtEndId = null;
        let routeLayer = null;

        // --- INIT ---
        function initApp() {
            populateDateFilter();
            populateFilterDropdowns(); // Fill City & Type
            
            try {
                const saved = localStorage.getItem('myFavorites');
                if (saved) favorites = JSON.parse(saved);
            } catch (e) { console.log("Local storage error"); }

            initMap();

            // Restore Saved Drive Time Route
            const savedRoute = localStorage.getItem('savedRoute');
            if (savedRoute) {
                try {
                    const { startId, endId } = JSON.parse(savedRoute);
                    if (startId && endId) {
                        const s = listings.find(i => String(i.id) === String(startId));
                        const e = listings.find(i => String(i.id) === String(endId));
                        
                        if (s && e) {
                            toggleDriveTimeMode(true); // Turn on mode, preserve state
                            dtStartId = startId;
                            dtEndId = endId;
                            updateDriveTimeUI();
                            refreshDriveTimeMarkers();
                            calculateRoute();
                        }
                    }
                } catch(err) { console.error("Error loading saved route", err); }
            }
        }

        function populateDateFilter() {
            const dateSelect = document.getElementById('dateFilter');
            const dates = [...new Set(listings.map(item => item.openDate))];
            dates.forEach(date => {
                const option = document.createElement('option');
                option.value = date;
                option.text = date;
                dateSelect.appendChild(option);
            });
        }

        function populateFilterDropdowns() {
            // City
            const citySelect = document.getElementById('filterCity');
            const cities = [...new Set(listings.map(item => item.rawData.CITY))].sort();
            cities.forEach(city => {
                const opt = document.createElement('option');
                opt.value = city;
                opt.text = city;
                citySelect.appendChild(opt);
            });

            // Type
            const typeSelect = document.getElementById('filterType');
            const types = [...new Set(listings.map(item => item.rawData["PROPERTY TYPE"]))].sort();
            types.forEach(type => {
                const opt = document.createElement('option');
                opt.value = type;
                opt.text = type;
                typeSelect.appendChild(opt);
            });
        }

        // --- CUSTOM ICONS ---
        function getIcon(isActive, isFav, dtIndex) {
            let iconClass = 'fa-location-dot';
            let colorClass = 'text-blue-600';
            let badgeHtml = '';

            // Drive Time Logic
            if (dtIndex === 1) {
                // Start Point - Distinct Style (e.g., Greenish)
                colorClass = 'text-emerald-600';
                badgeHtml = '<div class="dt-badge">1</div>';
            } else if (dtIndex === 2) {
                // End Point - Distinct Style (e.g., Orange/Red)
                colorClass = 'text-orange-600';
                badgeHtml = '<div class="dt-badge">2</div>';
            } else {
                // Normal Logic
                if (isFav) {
                    iconClass = 'fa-heart';
                    colorClass = 'text-red-500';
                } else if (isActive) {
                    colorClass = 'text-red-600';
                }
            }
            
            const sizeClass = isActive || dtIndex ? 'text-5xl' : 'text-3xl';
            const anchor = isActive || dtIndex ? [18, 42] : [10, 24];

            return L.divIcon({
                className: 'custom-div-icon',
                html: `<div class="marker-pin"><i class="fa-solid ${iconClass} ${colorClass} ${sizeClass}"></i>${badgeHtml}</div>`,
                iconSize: [30, 42],
                iconAnchor: anchor,
                popupAnchor: [0, -32]
            });
        }

        function initMap() {
            const centerLat = listings[0].lat;
            const centerLng = listings[0].lng;

            map = L.map('map').setView([centerLat, centerLng], 13);

            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                maxZoom: 19,
                attribution: '© OpenStreetMap contributors'
            }).addTo(map);

            renderMarkers(currentFilteredData);
            map.on('moveend', updateListBasedOnBounds);
        }

        // --- DRIVE TIME LOGIC ---

        function toggleDriveTimeMode(preserveState = false) {
            if (isDriveTimeMode && !preserveState) {
                // Turn OFF
                isDriveTimeMode = false;
                clearDriveTimeRoute(); // Resets selections & map & clears storage
                document.getElementById('driveTimePanel').classList.add('hidden');
                document.getElementById('driveTimeBtn').classList.remove('bg-emerald-800');
                document.getElementById('driveTimeBtn').classList.add('bg-emerald-600');
                
                // Restore map functionality
                applyFilters(); // Re-render markers based on current filters
            } else {
                // Turn ON
                isDriveTimeMode = true;
                document.getElementById('driveTimePanel').classList.remove('hidden');
                document.getElementById('driveTimeBtn').classList.remove('bg-emerald-600');
                document.getElementById('driveTimeBtn').classList.add('bg-emerald-800');
                
                if (!preserveState) {
                    // Clear any current selections just in case
                    dtStartId = null;
                    dtEndId = null;
                    updateDriveTimeUI();
                }
            }
        }

        function clearDriveTimeRoute() {
            dtStartId = null;
            dtEndId = null;
            if (routeLayer) {
                map.removeLayer(routeLayer);
                routeLayer = null;
            }
            document.getElementById('driveTimeResults').classList.add('hidden');
            updateDriveTimeUI();
            
            // Clear Storage
            localStorage.removeItem('savedRoute');
            
            // Restore visibility of all filtered markers
            // We use renderMarkers with currentFilteredData to show everyone again
            renderMarkers(currentFilteredData); 
        }

        function handleDriveTimeClick(id) {
            // Check for double click on same marker
            if (dtStartId === id || dtEndId === id) {
                // Cannot select same point twice
                return;
            }

            if (!dtStartId) {
                // 1. Select First Point
                dtStartId = id;
                updateDriveTimeUI();
                refreshDriveTimeMarkers(); // Update icon styles
            } else if (!dtEndId) {
                // 2. Select Second Point & Calculate
                dtEndId = id;
                updateDriveTimeUI();
                refreshDriveTimeMarkers();
                calculateRoute();
            } else {
                // 3. Third Click -> Reset to new Start Point
                dtStartId = id;
                dtEndId = null;
                if (routeLayer) {
                    map.removeLayer(routeLayer);
                    routeLayer = null;
                }
                document.getElementById('driveTimeResults').classList.add('hidden');
                updateDriveTimeUI();
                
                // Reset map to show all candidates again so user can pick a 2nd point
                renderMarkers(currentFilteredData); 
                // Then manually highlight the new start point
                refreshDriveTimeMarkers();
            }
        }

        function updateDriveTimeUI() {
            const startEl = document.getElementById('dtStartText');
            const endEl = document.getElementById('dtEndText');
            const statusEl = document.getElementById('dtStatusText');

            // Find Objects
            const startItem = listings.find(i => String(i.id) === String(dtStartId));
            const endItem = listings.find(i => String(i.id) === String(dtEndId));

            startEl.textContent = startItem ? truncate(startItem.title) : "Click a pin on the map";
            endEl.textContent = endItem ? truncate(endItem.title) : "Click another pin on the map";

            if (!dtStartId) {
                statusEl.textContent = "Select two points to calculate drive time";
                statusEl.className = "text-gray-800 font-medium";
            } else if (!dtEndId) {
                statusEl.textContent = "First point selected, now choose a second point";
                statusEl.className = "text-emerald-700 font-bold";
            } else {
                statusEl.textContent = "Route calculated";
                statusEl.className = "text-emerald-700 font-bold";
            }
        }

        function truncate(str) {
            return str.length > 30 ? str.substring(0, 30) + '...' : str;
        }

        function refreshDriveTimeMarkers() {
            // Update marker icons to show "1" and "2" badges
            for (let mId in markers) {
                const mIdStr = String(mId);
                let dtIndex = 0;
                if (mIdStr === String(dtStartId)) dtIndex = 1;
                if (mIdStr === String(dtEndId)) dtIndex = 2;

                const isFav = favorites.includes(mIdStr);
                const isActive = activeId === mIdStr; // Keep active logic if user clicked sidebar?
                
                markers[mId].setIcon(getIcon(isActive, isFav, dtIndex));
                
                // Ensure selected markers are on top
                if (dtIndex > 0) markers[mId].setZIndexOffset(2000);
                else markers[mId].setZIndexOffset(0);
            }
        }

        async function calculateRoute() {
            const startItem = listings.find(i => String(i.id) === String(dtStartId));
            const endItem = listings.find(i => String(i.id) === String(dtEndId));

            if (!startItem || !endItem) return;

            const url = `https://router.project-osrm.org/route/v1/driving/${startItem.lng},${startItem.lat};${endItem.lng},${endItem.lat}?overview=full&geometries=geojson`;

            try {
                const response = await fetch(url);
                const data = await response.json();

                if (data.routes && data.routes.length > 0) {
                    const route = data.routes[0];
                    const geoJson = route.geometry;
                    
                    // Draw Route
                    if (routeLayer) map.removeLayer(routeLayer);
                    routeLayer = L.geoJSON(geoJson, {
                        style: { color: '#059669', weight: 5, opacity: 0.8 }
                    }).addTo(map);

                    // Fit Bounds
                    const bounds = routeLayer.getBounds();
                    map.fitBounds(bounds.pad(0.2));

                    // Filter UI to ONLY show these two points
                    renderMarkers([startItem, endItem]); // Only render the 2 pins
                    
                    // Show Results
                    showDriveTimeResults(route.distance, route.duration, startItem, endItem);
                    
                    // Save to Storage
                    localStorage.setItem('savedRoute', JSON.stringify({ startId: dtStartId, endId: dtEndId }));

                } else {
                    document.getElementById('dtStatusText').textContent = "Unable to calculate route. Try again.";
                    document.getElementById('dtStatusText').className = "text-red-600 font-bold";
                }
            } catch (error) {
                console.error("Routing Error", error);
                document.getElementById('dtStatusText').textContent = "Routing service error.";
                document.getElementById('dtStatusText').className = "text-red-600 font-bold";
            }
        }

        function showDriveTimeResults(distMeters, durSeconds, start, end) {
            const miles = Math.round(distMeters / 1609.34); // Nearest Integer
            
            // Format Time (X hr Y min)
            const totalMinutes = Math.round(durSeconds / 60);
            const hours = Math.floor(totalMinutes / 60);
            const mins = totalMinutes % 60;
            
            let timeString = `${mins} min`;
            if (hours > 0) {
                timeString = `${hours} hr ${mins} min`;
            }

            document.getElementById('resTime').innerText = timeString;
            document.getElementById('resDist').innerText = `${miles} miles`;
            
            // Google Maps Link
            const gMapsUrl = `https://www.google.com/maps/dir/${start.lat},${start.lng}/${end.lat},${end.lng}/`;
            document.getElementById('googleMapsLink').href = gMapsUrl;

            document.getElementById('driveTimeResults').classList.remove('hidden');
        }


        // --- MAP & LIST LOGIC ---

        function updateListBasedOnBounds() {
            // In Drive Time mode, if we have a route, we force the list to only show the 2 selected points
            // This is handled by renderMarkers([start, end]) called in calculateRoute
            // But if user pans map manually in DT mode, we might want to respect bounds? 
            // Requirement says "Filter visible homes to just those two selected points". 
            // So standard bounds logic only applies if NOT in route view.
            
            if (isDriveTimeMode && dtStartId && dtEndId) {
                // Do nothing, list is already restricted to 2 items
                return; 
            }

            const bounds = map.getBounds();
            const visibleListings = currentFilteredData.filter(item => {
                const latLng = L.latLng(item.lat, item.lng);
                return bounds.contains(latLng);
            });
            renderSidebar(visibleListings);
        }

        function toggleFavorite(e, id) {
            e.stopPropagation();
            const strId = String(id);
            if (favorites.includes(strId)) {
                favorites = favorites.filter(favId => favId !== strId);
            } else {
                favorites.push(strId);
            }
            localStorage.setItem('myFavorites', JSON.stringify(favorites));
            
            if (markers[strId]) {
                // Refresh icon styling (handles favorite heart vs drive time badge)
                let dtIndex = 0;
                if (String(strId) === String(dtStartId)) dtIndex = 1;
                if (String(strId) === String(dtEndId)) dtIndex = 2;
                
                const isActive = activeId === strId;
                const isFav = favorites.includes(strId);
                markers[strId].setIcon(getIcon(isActive, isFav, dtIndex));
            }

            if (isFavFilterActive) applyFilters();
            else updateListBasedOnBounds();
        }

        function toggleFavFilter() {
            isFavFilterActive = !isFavFilterActive;
            const btn = document.getElementById('favFilterBtn');
            if (isFavFilterActive) {
                btn.classList.add('bg-red-50', 'border-red-200', 'text-red-600');
                btn.classList.remove('text-gray-600', 'hover:bg-gray-50');
                btn.innerHTML = `<i class="fa-solid fa-heart text-red-500"></i> <span class="hidden sm:inline">Saved</span>`;
            } else {
                btn.classList.remove('bg-red-50', 'border-red-200', 'text-red-600');
                btn.classList.add('text-gray-600', 'hover:bg-gray-50');
                btn.innerHTML = `<i class="fa-regular fa-heart text-red-500"></i> <span class="hidden sm:inline">Favorites</span>`;
            }
            applyFilters();
        }

        function openFilterModal() {
            document.getElementById('filterModal').classList.remove('hidden');
        }

        function applyFiltersAndClose() {
            applyFilters();
            closeModal('filterModal');
        }

        function resetFilters() {
            document.getElementById('filterTimeStart').value = "";
            document.getElementById('filterTimeEnd').value = "";
            document.getElementById('filterCity').value = "";
            document.getElementById('filterType').value = "";
            document.getElementById('filterPriceMin').value = "";
            document.getElementById('filterPriceMax').value = "";
            document.getElementById('filterBeds').value = "";
            document.getElementById('filterBaths').value = "";
            document.getElementById('filterSqft').value = "";
            document.getElementById('filterLot').value = "";
            document.getElementById('filterYear').value = "";
            document.getElementById('filterDom').value = "";
            document.getElementById('filterPpsf').value = "";
            document.getElementById('filterHoa').value = "";
            
            applyFilters();
        }

        function applyFilters() {
            // 1. Get Values
            const selectedDate = document.getElementById('dateFilter').value;
            
            // Modal Values
            const timeStart = parseInt(document.getElementById('filterTimeStart').value) || null;
            const timeEnd = parseInt(document.getElementById('filterTimeEnd').value) || null;
            const city = document.getElementById('filterCity').value;
            const type = document.getElementById('filterType').value;
            
            const priceMin = parseInt(document.getElementById('filterPriceMin').value) || 0;
            const priceMax = parseInt(document.getElementById('filterPriceMax').value) || Infinity;
            
            const minBeds = parseFloat(document.getElementById('filterBeds').value) || 0;
            const minBaths = parseFloat(document.getElementById('filterBaths').value) || 0;
            const minSqft = parseFloat(document.getElementById('filterSqft').value) || 0;
            const minLot = parseFloat(document.getElementById('filterLot').value) || 0;
            const minYear = parseInt(document.getElementById('filterYear').value) || 0;
            const minDom = parseInt(document.getElementById('filterDom').value) || 0;
            const minPpsf = parseInt(document.getElementById('filterPpsf').value) || 0;
            const minHoa = parseInt(document.getElementById('filterHoa').value) || 0;

            // 2. Filter
            currentFilteredData = listings.filter(item => {
                const rd = item.rawData;

                // Base Header Filters
                const matchDate = selectedDate === 'all' || item.openDate === selectedDate;
                const matchFav = isFavFilterActive ? favorites.includes(String(item.id)) : true;

                // Modal Filters
                const matchPrice = item.price >= priceMin && item.price <= priceMax;
                const matchCity = city === "" || rd.CITY === city;
                const matchType = type === "" || rd["PROPERTY TYPE"] === type;
                
                // Time
                const matchTimeStart = timeStart === null || rd["24 Start Time"] <= timeStart;
                const matchTimeEnd = timeEnd === null || rd["24 End Time"] >= timeEnd;

                // Thresholds (Min)
                const matchBeds = item.beds >= minBeds;
                const matchBaths = item.baths >= minBaths;
                const matchSqft = item.sqft >= minSqft;
                const matchLot = (rd["LOT SIZE"] || 0) >= minLot;
                const matchYear = (rd["YEAR BUILT"] || 0) >= minYear;
                const matchDom = (rd["DAYS ON MARKET"] || 0) >= minDom;
                const matchPpsf = (rd["$/SQUARE FEET"] || 0) >= minPpsf;
                const matchHoa = (rd["HOA/MONTH"] || 0) >= minHoa;

                return matchDate && matchFav && matchPrice && matchCity && matchType &&
                       matchTimeStart && matchTimeEnd && matchBeds && matchBaths &&
                       matchSqft && matchLot && matchYear && matchDom && matchPpsf && matchHoa;
            });

            // Re-render
            renderMarkers(currentFilteredData);
        }

        // --- RENDER ---
        function renderMarkers(data) {
            // Clear existing markers
            for (let id in markers) {
                map.removeLayer(markers[id]);
            }
            markers = {};

            data.forEach(item => {
                const isActive = activeId === item.id;
                const isFav = favorites.includes(String(item.id));
                
                // Check Drive Time State
                let dtIndex = 0;
                if (String(item.id) === String(dtStartId)) dtIndex = 1;
                if (String(item.id) === String(dtEndId)) dtIndex = 2;

                const marker = L.marker([item.lat, item.lng], { icon: getIcon(isActive, isFav, dtIndex) }).addTo(map);
                
                // Add popup content
                marker.bindPopup(`
                    <div class="text-center">
                        <strong class="block text-gray-800 text-sm mb-1">${item.title}</strong>
                        <div class="text-blue-600 font-bold">$${item.price.toLocaleString()}</div>
                    </div>
                `);

                marker.on('click', () => {
                    if (isDriveTimeMode) {
                        handleDriveTimeClick(item.id);
                        marker.closePopup(); // Prevent popup in selection mode if preferred
                    } else {
                        handleListingSelection(item.id, false); 
                        scrollToCard(item.id);
                    }
                });
                markers[item.id] = marker;
            });

            // Update Sidebar for these markers
            renderSidebar(data);

            // Fit bounds only if not in Drive Time Route Mode (route layer handles its own bounds)
            if (data.length > 0 && !activeId && !routeLayer) {
                const group = new L.featureGroup(data.map(i => markers[i.id]));
                map.fitBounds(group.getBounds().pad(0.1));
            }
        }

        function renderSidebar(data) {
            const container = document.getElementById('listings-container');
            container.innerHTML = '';

            if (data.length === 0) {
                container.innerHTML = `
                    <div class="p-8 text-center text-gray-500">
                        <p class="mb-2">No listings found.</p>
                        ${isFavFilterActive ? '<p class="text-xs">Try unchecking "Saved".</p>' : '<button onclick="resetFilters()" class="text-blue-600 hover:underline text-sm">Reset Filters</button>'}
                    </div>`;
                return;
            }

            data.forEach(item => {
                const isFav = favorites.includes(String(item.id));
                const card = document.createElement('div');
                card.id = `listing-${item.id}`;
                card.className = "border-b border-gray-100 hover:bg-gray-50 transition p-4 flex gap-4 relative group";
                if (activeId === item.id) card.classList.add('card-active');
                
                card.innerHTML = `
                    <div class="flex-1 min-w-0 pr-2 cursor-pointer" onclick="handleListingSelection('${item.id}', true)">
                        <div class="flex justify-between items-start">
                            <h3 class="font-bold text-gray-800 truncate text-base">${item.title}</h3>
                        </div>
                        <div class="text-blue-600 font-bold text-lg mb-1">$${item.price.toLocaleString()}</div>
                        <p class="text-xs text-gray-500 mb-2 truncate"><i class="fa-solid fa-location-dot mr-1"></i>${item.address}</p>
                        
                        <div class="flex gap-3 text-xs text-gray-600 mb-2 font-medium">
                            <span><i class="fa-solid fa-bed"></i> ${item.beds}bd</span>
                            <span><i class="fa-solid fa-bath"></i> ${item.baths}ba</span>
                            <span><i class="fa-solid fa-ruler-combined"></i> ${item.sqft} sqft</span>
                        </div>

                        <div class="bg-blue-50 text-blue-800 text-xs px-2 py-1 rounded inline-block font-semibold border border-blue-100">
                            <i class="fa-regular fa-clock mr-1"></i> ${item.openDate} • ${item.openTime}
                        </div>
                    </div>

                    <div class="flex flex-col gap-2 justify-between items-end">
                        <button onclick="toggleFavorite(event, '${item.id}')" class="w-8 h-8 flex items-center justify-center rounded-full hover:bg-gray-100 transition">
                            <i class="${isFav ? 'fa-solid text-red-500' : 'fa-regular text-gray-300 group-hover:text-gray-400'} fa-heart text-xl"></i>
                        </button>
                        <button onclick="openModal('${item.id}')" class="bg-gray-800 text-white text-xs px-3 py-1.5 rounded hover:bg-gray-700 transition">Details</button>
                    </div>
                `;
                container.appendChild(card);
            });
        }

        function handleListingSelection(id, shouldPan) {
            // Standard selection logic (disabled or secondary in Drive Time mode)
            if (isDriveTimeMode) return; 

            activeId = id;
            document.querySelectorAll('#listings-container > div').forEach(el => el.classList.remove('card-active'));
            const currCard = document.getElementById(`listing-${id}`);
            if (currCard) currCard.classList.add('card-active');

            for (let mId in markers) {
                const isTarget = String(mId) === String(id);
                const marker = markers[mId];
                const isFav = favorites.includes(String(mId));
                
                // Only update standard icons, preserve DT badges if somehow mixed?
                // Currently listing selection disabled in DT mode to prevent conflicts
                marker.setIcon(getIcon(isTarget, isFav, 0));
                
                if (isTarget) {
                    marker.setZIndexOffset(1000);
                    if (shouldPan) map.panTo(marker.getLatLng());
                } else {
                    marker.setZIndexOffset(0);
                }
            }
        }

        function scrollToCard(id) {
            const card = document.getElementById(`listing-${id}`);
            if (card) card.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }

        // --- MODAL LOGIC ---
        function openModal(id) {
            const item = listings.find(i => String(i.id) === String(id));
            if (!item) return;

            document.getElementById('modalPrice').innerText = `$${item.price.toLocaleString()}`;
            document.getElementById('modalTime').innerText = `${item.openDate} | ${item.openTime}`;
            document.getElementById('modalAddress').innerText = item.title;

            const grid = document.getElementById('modalGrid');
            grid.innerHTML = '';
            
            for (const [key, value] of Object.entries(item.rawData)) {
                if (value === null || value === "") continue; 
                
                const div = document.createElement('div');
                div.className = "flex flex-col border-b border-gray-100 py-2";
                
                let valueHtml = `<span class="text-gray-900 font-medium">${value}</span>`;
                if (key === 'URL') {
                    valueHtml = `<a href="${value}" target="_blank" class="text-blue-600 hover:underline break-all">${value}</a>`;
                }

                div.innerHTML = `
                    <span class="text-xs font-bold text-gray-500 uppercase tracking-wide">${key}</span>
                    ${valueHtml}
                `;
                grid.appendChild(div);
            }
            document.getElementById('detailsModal').classList.remove('hidden');
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.add('hidden');
        }

        // Initialize App
        window.onload = initApp;

    </script>
</body>
</html>
